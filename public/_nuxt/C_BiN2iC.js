var H=Object.defineProperty;var M=(o,e,s)=>e in o?H(o,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[e]=s;var L=(o,e,s)=>M(o,typeof e!="symbol"?e+"":e,s);import{ah as E,a$ as P,u as h,b0 as q,b1 as U,r as x,c as z,m as $,l as F,b2 as A}from"./CUNWPMFO.js";import{H as C}from"./CxvClpzF.js";class G{constructor(e){L(this,"RESOURCE","auth/login");this.httpFactory=e}async login(e){const s={route:this.RESOURCE,method:"POST",body:e};return this.httpFactory.call(s)}}const R=E("lastRoute",{state:()=>({route:"/home"}),actions:{lastKnownRoute(o){this.route=o}},persist:{storage:sessionStorage}}),K=E("session",{state:()=>({isOpen:!1}),actions:{setIsOpen(o){this.isOpen=o}},persist:{storage:P.sessionStorage}});function N(o,e){const s=e/o*100;return 2/Math.PI*100*Math.atan(s/50)}function j(o={}){const{duration:e=2e3,throttle:s=200,hideDelay:a=500,resetDelay:i=400}=o,g=o.estimatedProgress||N,u=h(),n=x(0),t=x(!1),f=x(!1);let p=!1,d,m,v,T;const S=()=>{f.value=!1,k(0)};function k(r=0){if(!u.isHydrating){if(r>=100)return l();c(),n.value=r<0?0:r,s?m=setTimeout(()=>{t.value=!0,D()},s):(t.value=!0,D())}}function _(){v=setTimeout(()=>{t.value=!1,T=setTimeout(()=>{n.value=0},i)},a)}function l(r={}){n.value=100,p=!0,c(),y(),r.error&&(f.value=!0),r.force?(n.value=0,t.value=!1):_()}function y(){clearTimeout(v),clearTimeout(T)}function c(){clearTimeout(m),cancelAnimationFrame(d)}function D(){p=!1;let r;function b(w){if(p)return;r??(r=w);const O=w-r;n.value=Math.max(0,Math.min(100,g(e,O))),d=requestAnimationFrame(b)}d=requestAnimationFrame(b)}let I=()=>{};{const r=u.hook("page:loading:start",()=>{S()}),b=u.hook("page:loading:end",()=>{l()}),w=u.hook("vue:error",()=>l());I=()=>{w(),r(),b(),c()}}return{_cleanup:I,progress:z(()=>n.value),isLoading:z(()=>t.value),error:z(()=>f.value),start:S,set:k,finish:l,clear:c}}function B(o={}){const e=h(),s=e._loadingIndicator=e._loadingIndicator||j(o);return q()&&(e._loadingIndicatorDeps=e._loadingIndicatorDeps||0,e._loadingIndicatorDeps++,U(()=>{e._loadingIndicatorDeps--,e._loadingIndicatorDeps===0&&(s._cleanup(),delete e._loadingIndicator)})),s}async function J(o){const e={route:F.refreshToken,method:"GET",token:o},{data:s,error:a,pending:i}=await $(e);return s.value&&h().$toast.success("Session refreshed successfully!"),{data:s,error:a,pending:i}}const X=E("auth",{state:()=>({authenticated:!1,loading:!1,user:{},token:"",department:"",locations:[],selectedLocation:"",serverDatetimeDiff:0}),actions:{async authenticateUser({username:o,password:e,department:s}){var d,m,v,T,S,k,_,l;let a=new G(new C);const i=A(),g={username:o,password:e,department:s},{$toast:u,$router:n}=h(),{data:t,error:f,pending:p}=await a.login(g);if(this.loading=p,f.value&&u.error(f.value.data.error),t.value){let y=new Date((d=t==null?void 0:t.value)==null?void 0:d.authorization.expiry_time);y.setHours(y.getHours());const{route:c}=R();if(i.setToken((m=t==null?void 0:t.value)==null?void 0:m.authorization.token),i.token!=null){this.authenticated=!0,this.user=(v=t==null?void 0:t.value)==null?void 0:v.authorization.user,this.department=s,this.locations=(T=t==null?void 0:t.value)==null?void 0:T.authorization.user.lab_locations;const D=Date.now();this.serverDatetimeDiff=new Date((S=t==null?void 0:t.value)==null?void 0:S.authorization.server_time).getTime()-D,i.setSessionExpiresAt((k=t==null?void 0:t.value)==null?void 0:k.authorization.expiry_time);const I=((_=t==null?void 0:t.value)==null?void 0:_.authorization.user.lab_locations.length)>1;u.success(`Logged in as ${o}`),I?n.push("/locations"):(this.selectedLocation=(l=t==null?void 0:t.value)==null?void 0:l.authorization.user.lab_locations[0].name,c==""?n.push("/home"):n.push(c))}}},async logUserOut(){const o=A(),{start:e,finish:s}=B(),a=K();e();const{lastKnownRoute:i}=R(),g={route:F.logout,method:"GET",token:`${o.token}`},{data:u,error:n}=await $(g);u.value&&(i("/home"),a.setIsOpen(!1),o.clearToken(),h().$toast.success("Successfully logged out"),setTimeout(()=>{s(),h().$router.push("/")},1e3)),n.value&&(console.error("error: ",n.value),s(),h().$toast.error("Failed to log out"))},async refreshToken(){const o=A(),{data:e,error:s,pending:a}=await J(`${o.token}`);return e.value&&(o.setToken(e.value.authorization.token),o.setSessionExpiresAt(e.value.authorization.expiry_time)),s.value&&console.error(s.value),{data:e,error:s,pending:a}}},persist:{storage:sessionStorage}});export{R as a,B as b,K as c,X as u};

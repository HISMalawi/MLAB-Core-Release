var _=Object.defineProperty;var b=(t,s,o)=>s in t?_(t,s,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[s]=o;var z=(t,s,o)=>b(t,typeof s!="symbol"?s+"":s,o);import{ah as h,a$ as A,m as $,u as a,l as x,b0 as l}from"./CFWOeWkC.js";import{H as L}from"./dHooFwXv.js";import{u as q}from"./C-ThMoHK.js";class F{constructor(s){z(this,"RESOURCE","auth/login");this.httpFactory=s}async login(s){const o={route:this.RESOURCE,method:"POST",body:s};return this.httpFactory.call(o)}}const R=h("lastRoute",{state:()=>({route:"/home"}),actions:{lastKnownRoute(t){this.route=t}},persist:{storage:sessionStorage}}),H=h("session",{state:()=>({isOpen:!1}),actions:{setIsOpen(t){this.isOpen=t}},persist:{storage:A.sessionStorage}});async function U(t){const s={route:x.refreshToken,method:"GET",token:t},{data:o,error:r,pending:n}=await $(s);return o.value&&a().$toast.success("Session refreshed successfully!"),{data:o,error:r,pending:n}}const K=h("auth",{state:()=>({authenticated:!1,loading:!1,user:{},token:"",department:"",locations:[],selectedLocation:"",serverDatetimeDiff:0}),actions:{async authenticateUser({username:t,password:s,department:o}){var f,g,m,v,S,k,d,y;let r=new F(new L);const n=l(),c={username:t,password:s,department:o},{$toast:u,$router:i}=a(),{data:e,error:p,pending:E}=await r.login(c);if(this.loading=E,p.value&&u.error(p.value.data.error),e.value){let T=new Date((f=e==null?void 0:e.value)==null?void 0:f.authorization.expiry_time);T.setHours(T.getHours());const{route:w}=R();if(n.setToken((g=e==null?void 0:e.value)==null?void 0:g.authorization.token),n.token!=null){this.authenticated=!0,this.user=(m=e==null?void 0:e.value)==null?void 0:m.authorization.user,this.department=o,this.locations=(v=e==null?void 0:e.value)==null?void 0:v.authorization.user.lab_locations;const O=Date.now();this.serverDatetimeDiff=new Date((S=e==null?void 0:e.value)==null?void 0:S.authorization.server_time).getTime()-O,n.setSessionExpiresAt((k=e==null?void 0:e.value)==null?void 0:k.authorization.expiry_time);const D=((d=e==null?void 0:e.value)==null?void 0:d.authorization.user.lab_locations.length)>1;u.success(`Logged in as ${t}`),D?i.push("/locations"):(this.selectedLocation=(y=e==null?void 0:e.value)==null?void 0:y.authorization.user.lab_locations[0].name,w==""?i.push("/home"):i.push(w))}}},async logUserOut(){const t=l(),{start:s,finish:o}=q(),r=H();s();const{lastKnownRoute:n}=R(),c={route:x.logout,method:"GET",token:`${t.token}`},{data:u,error:i}=await $(c);u.value&&(n("/home"),r.setIsOpen(!1),t.clearToken(),a().$toast.success("Successfully logged out"),setTimeout(()=>{o(),a().$router.push("/")},1e3)),i.value&&(console.error("error: ",i.value),o(),a().$toast.error("Failed to log out"))},async refreshToken(){const t=l(),{data:s,error:o,pending:r}=await U(`${t.token}`);return s.value&&(t.setToken(s.value.authorization.token),t.setSessionExpiresAt(s.value.authorization.expiry_time)),o.value&&console.error(o.value),{data:s,error:o,pending:r}}},persist:{storage:sessionStorage}});export{R as a,H as b,K as u};
